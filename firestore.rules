/**
 * @fileoverview Firestore Security Rules for the e-commerce application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict admin-only access model for managing core application data. Public read access is granted where necessary for the user-facing storefront.
 *
 * Data Structure:
 * - /products/{productId}: Stores product information. Publicly readable.
 * - /categories/{categoryId}: Stores category information. Publicly readable.
 * - /banners/{bannerId}: Stores promotional banner information. Publicly readable.
 * - /roles_admin/{uid}: Indicates admin privileges; presence of a document for a user grants admin rights.
 * - /settings/enquiry: Stores WhatsApp enquiry settings. Publicly readable, admin writable.
 *
 * Key Security Decisions:
 * - Public read access: All users (authenticated or not) can read products, categories, banners, and enquiry settings.
 * - Admin-only write access: All write operations on core data collections are restricted to admin users.
 * - Authorization Independence: Admin status is determined solely by the existence of a document in /roles_admin/{uid}, avoiding costly `get()` calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the current user is signed in.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Verified Identity: Ensures that all authorization decisions are based on a verified user identity.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the current user is an admin by verifying the existence of their UID in the roles_admin collection.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Role-Based Access Control: Only users with an admin role can access certain resources.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Rules for the /products collection.
     * @path /products/{productId}
     * @allow (read) Anyone can view products.
     * @allow (write) An admin can manage products.
     * @deny (write) A non-admin attempts to manage a product.
     * @principle Public Read, Admin Write: Allows public visibility of products while securing management.
     */
    match /products/{productId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /**
     * @description Rules for the /categories collection.
     * @path /categories/{categoryId}
     * @allow (read) Anyone can view categories.
     * @allow (write) An admin can manage categories.
     * @deny (write) A non-admin attempts to manage a category.
     * @principle Public Read, Admin Write: Allows public visibility of categories while securing management.
     */
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /**
     * @description Rules for the /banners collection.
     * @path /banners/{bannerId}
     * @allow (read) Anyone can view banners.
     * @allow (write) An admin can manage banners.
     * @deny (write) A non-admin attempts to manage a banner.
     * @principle Public Read, Admin Write: Allows public visibility of banners while securing management.
     */
    match /banners/{bannerId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /**
     * @description Rules for the /roles_admin collection.
     * @path /roles_admin/{uid}
     * @allow (get) Any signed-in user's token can be used by server-side rules (like Storage rules) to check for a document's existence. This rule does NOT allow client-side reads.
     * @allow (list, write) Only admins can manage other admin roles.
     * @deny (write) A non-admin attempts to create an admin role.
     */
    match /roles_admin/{uid} {
        allow get: if isSignedIn();
        allow list, create, update, delete: if isAdmin();
    }

    /**
     * @description Rules for the /settings document. This allows storing various app settings.
     * @path /settings/{settingId}
     * @allow (read) Anyone can read settings.
     * @allow (write) Only admins can change settings.
     * @deny (write) A non-admin attempts to change a setting.
     */
    match /settings/{settingId} {
        allow read: if true;
        allow write: if isAdmin();
    }
  }
}
